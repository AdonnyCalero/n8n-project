// Funciones de Administrador con Dashboard Mejorado

// Variable global para el gráfico
let tablesChart = null;

// Cargar dashboard de administrador
async function loadAdminDashboard() {
    await loadDashboard();
    await loadTablesChart();
}

// Cargar gráfica de mesas por zonas
async function loadTablesChart() {
    try {
        const response = await fetch(`${API_BASE}/mesas`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        const tables = await response.json();
        
        if (response.ok) {
            renderTablesChart(tables);
        } else {
            showToast('Error al cargar mesas', 'danger');
        }
    } catch (error) {
        showToast('Error de conexión', 'danger');
    }
}

// Renderizar gráfica de mesas por zonas
function renderTablesChart(tables) {
    const ctx = document.getElementById('tablesByZoneChart').getContext('2d');
    
    // Agrupar mesas por zona
    const zonas = {};
    tables.forEach(table => {
        const zonaName = table.zona_nombre || 'Sin Zona';
        if (!zonas[zonaName]) {
            zonas[zonaName] = { disponible: 0, ocupada: 0, reservada: 0, mantenimiento: 0 };
        }
        zonas[zonaName][table.estado]++;
    });
    
    // Preparar datos para Chart.js
    const labels = Object.keys(zonas);
    const datasets = [
        {
            label: 'Disponibles',
            data: labels.map(zona => zonas[zona].disponible || 0),
            backgroundColor: 'rgba(40, 167, 69, 0.8)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1
        },
        {
            label: 'Ocupadas',
            data: labels.map(zona => zonas[zona].ocupada || 0),
            backgroundColor: 'rgba(220, 53, 69, 0.8)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1
        },
        {
            label: 'Reservadas',
            data: labels.map(zona => zonas[zona].reservada || 0),
            backgroundColor: 'rgba(255, 193, 7, 0.8)',
            borderColor: 'rgba(255, 193, 7, 1)',
            borderWidth: 1
        },
        {
            label: 'Mantenimiento',
            data: labels.map(zona => zonas[zona].mantenimiento || 0),
            backgroundColor: 'rgba(108, 117, 125, 0.8)',
            borderColor: 'rgba(108, 117, 125, 1)',
            borderWidth: 1
        }
    ];
    
    // Destruir gráfico anterior si existe
    if (tablesChart) {
        tablesChart.destroy();
    }
    
    // Crear nuevo gráfico
    tablesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Zonas del Restaurante'
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Número de Mesas'
                    },
                    beginAtZero: true
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Estado de Mesas por Zona',
                    font: {
                        size: 16
                    }
                },
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw}`;
                        }
                    }
                }
            }
        }
    });
}

// Cargar todas las reservas (con acciones)
async function loadAllReservations() {
    try {
        const response = await fetch(`${API_BASE}/admin/reservas`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        const reservations = await response.json();
        
        if (response.ok) {
            renderAllReservationsTable(reservations);
            showToast('Reservas actualizadas', 'success');
        } else {
            showToast('Error al cargar reservas', 'danger');
        }
    } catch (error) {
        showToast('Error de conexión', 'danger');
    }
}

// Renderizar tabla de reservas con acciones
function renderAllReservationsTable(reservations) {
    const tbody = document.getElementById('allReservationsTable');
    tbody.innerHTML = '';
    
    reservations.forEach(reservation => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${reservation.id}</td>
            <td>${reservation.cliente_nombre}</td>
            <td>${reservation.email}</td>
            <td>${reservation.fecha}</td>
            <td>${reservation.hora}</td>
            <td>${reservation.mesa_numero}</td>
            <td>${reservation.numero_comensales}</td>
            <td><span class="badge status-${reservation.estado}">${capitalizeFirst(reservation.estado)}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editReservation(${reservation.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteReservation(${reservation.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Cargar estado de mesas
async function loadTablesStatus() {
    try {
        const response = await fetch(`${API_BASE}/mesas`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        const tables = await response.json();
        
        if (response.ok) {
            renderTablesGrid(tables);
        } else {
            showToast('Error al cargar mesas', 'danger');
        }
    } catch (error) {
        showToast('Error de conexión', 'danger');
    }
}

// Renderizar grid de mesas
function renderTablesGrid(tables) {
    const container = document.getElementById('tablesManagement');
    container.innerHTML = '';
    
    // Agrupar por zonas
    const zonas = {};
    tables.forEach(table => {
        const zonaName = table.zona_nombre || 'Sin Zona';
        if (!zonas[zonaName]) {
            zonas[zonaName] = [];
        }
        zonas[zonaName].push(table);
    });
    
    // Crear grid por zonas
    Object.keys(zonas).forEach(zonaName => {
        const zonaSection = document.createElement('div');
        zonaSection.className = 'mb-4';
        zonaSection.innerHTML = `
            <h5 class="mb-3">${zonaName}</h5>
            <div class="row g-3" id="zona-${zonaName.replace(/\s+/g, '-')}">
            </div>
        `;
        container.appendChild(zonaSection);
        
        const zonaContainer = document.getElementById(`zona-${zonaName.replace(/\s+/g, '-')}`);
        
        zonas[zonaName].forEach(table => {
            const tableCard = document.createElement('div');
            tableCard.className = 'col-md-3 col-sm-6 mb-3';
            
            const statusColor = getStatusColor(table.estado);
            const statusIcon = getStatusIcon(table.estado);
            
            tableCard.innerHTML = `
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="card-title">
                            <i class="${statusIcon}"></i> Mesa ${table.numero}
                        </h6>
                        <p class="card-text">
                            <strong>Capacidad:</strong> ${table.capacidad} personas<br>
                            <strong>Estado:</strong> <span class="badge ${statusColor}">${capitalizeFirst(table.estado)}</span><br>
                            ${table.zona_nombre ? `<small class="text-muted">Zona: ${table.zona_nombre}</small>` : ''}
                        </p>
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-sm btn-outline-success" onclick="updateTableStatus(${table.id}, 'disponible')">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="updateTableStatus(${table.id}, 'reservada')">
                                <i class="bi bi-calendar-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="updateTableStatus(${table.id}, 'ocupada')">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            zonaContainer.appendChild(tableCard);
        });
    });
}

// Obtener color según estado
function getStatusColor(status) {
    switch (status) {
        case 'disponible': return 'bg-success';
        case 'ocupada': return 'bg-danger';
        case 'reservada': return 'bg-warning';
        case 'mantenimiento': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

// Obtener icono según estado
function getStatusIcon(status) {
    switch (status) {
        case 'disponible': return 'bi bi-check-circle-fill text-success';
        case 'ocupada': return 'bi bi-x-circle-fill text-danger';
        case 'reservada': return 'bi bi-calendar-check-fill text-warning';
        case 'mantenimiento': return 'bi bi-tools text-secondary';
        default: return 'bi bi-question-circle text-secondary';
    }
}

// Actualizar estado de mesa
async function updateTableStatus(tableId, newStatus) {
    if (!confirm(`¿Cambiar la mesa ${tableId} a estado "${newStatus}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/mesas/${tableId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ estado: newStatus })
        });
        
        if (response.ok) {
            showToast('Estado de mesa actualizado', 'success');
            loadTablesStatus(); // Recargar grid
            loadTablesChart(); // Recargar gráfica
        } else {
            const error = await response.json();
            showToast(error.error || 'Error al actualizar estado', 'danger');
        }
    } catch (error) {
        showToast('Error de conexión', 'danger');
    }
}

// Editar reserva
async function editReservation(reservationId) {
    try {
        // Primero obtener datos de la reserva
        const response = await fetch(`${API_BASE}/reservas/${reservationId}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        const reservation = await response.json();
        
        if (response.ok) {
            // Mostrar modal de edición
            showEditReservationModal(reservation);
        } else {
            showToast('Error al obtener reserva', 'danger');
        }
    } catch (error) {
        showToast('Error de conexión', 'danger');
    }
}

// Eliminar reserva
async function deleteReservation(reservationId) {
    if (!confirm(`¿Está seguro de eliminar la reserva ${reservationId}? Esta acción no se puede deshacer.`)) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/reservas/${reservationId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Reserva eliminada exitosamente', 'success');
            loadAllReservations(); // Recargar tabla
            loadAdminDashboard(); // Recargar dashboard
        } else {
            showToast(result.error || 'Error al eliminar reserva', 'danger');
        }
    } catch (error) {
        showToast('Error de conexión', 'danger');
    }
}

// Mostrar modal de edición de reserva
function showEditReservationModal(reservation) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Editar Reserva #${reservation.id}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editReservationForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-control" id="editFecha" value="${reservation.fecha}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hora</label>
                                <input type="time" class="form-control" id="editHora" value="${reservation.hora}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Comensales</label>
                                <input type="number" class="form-control" id="editComensales" value="${reservation.numero_comensales}" min="1" max="12" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Estado</label>
                                <select class="form-control" id="editEstado">
                                    <option value="confirmada" ${reservation.estado === 'confirmada' ? 'selected' : ''}>Confirmada</option>
                                    <option value="cancelada" ${reservation.estado === 'cancelada' ? 'selected' : ''}>Cancelada</option>
                                    <option value="completada" ${reservation.estado === 'completada' ? 'selected' : ''}>Completada</option>
                                    <option value="no_asistio" ${reservation.estado === 'no_asistio' ? 'selected' : ''}>No asistió</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" id="editObservaciones" rows="3">${reservation.observaciones || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveReservationEdit(${reservation.id})">Guardar Cambios</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Limpiar al cerrar
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

// Guardar edición de reserva
async function saveReservationEdit(reservationId) {
    try {
        const formData = {
            fecha: document.getElementById('editFecha').value,
            hora: document.getElementById('editHora').value,
            numero_comensales: parseInt(document.getElementById('editComensales').value),
            observaciones: document.getElementById('editObservaciones').value,
            estado: document.getElementById('editEstado').value
        };
        
        const response = await fetch(`${API_BASE}/reservas/${reservationId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Reserva actualizada correctamente', 'success');
            // Cerrar modal
            const modal = document.querySelector('.modal.show');
            if (modal) {
                bootstrap.Modal.getInstance(modal).hide();
            }
            loadAllReservations(); // Recargar tabla
        } else {
            showToast(result.error || 'Error al actualizar reserva', 'danger');
        }
    } catch (error) {
        showToast('Error de conexión', 'danger');
    }
}

// Capitalizar primera letra
function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}