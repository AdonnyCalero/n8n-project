<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Bot√≥n Login - DEBUG COMPLETO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <style>
        .debug-section {
            border: 2px solid #dee2e6;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .debug-section h5 {
            background: #f8f9fa;
            padding: 10px;
            margin: 0;
            border-bottom: 1px solid #dee2e6;
        }
        .log-entry {
            font-family: monospace;
            font-size: 11px;
            padding: 2px;
            border-bottom: 1px solid #eee;
        }
        .log-entry.error { background: #f8d7da; }
        .log-entry.success { background: #d4edda; }
        .log-entry.warning { background: #fff3cd; }
        .log-entry.info { background: #d1ecf1; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üîß DIAGN√ìSTICO BOT√ìN LOGIN - DEBUG COMPLETO</h1>
        
        <div class="alert alert-warning">
            <h5>üéØ Objetivo:</h5>
            <p>Identificar exactamente por qu√© el bot√≥n "Iniciar Sesi√≥n" no responde al hacer click.</p>
        </div>

        <!-- Secci√≥n 1: Verificaci√≥n del DOM -->
        <div class="debug-section">
            <h5><i class="bi bi-search"></i> 1. VERIFICACI√ìN DEL DOM</h5>
            <div id="domStatus" class="alert alert-secondary">Verificando...</div>
            <div class="mt-3">
                <button class="btn btn-info" onclick="checkDOMElements()">
                    <i class="bi bi-eyeglass"></i> Verificar Elementos del Formulario
                </button>
                <button class="btn btn-warning" onclick="inspectLoginButton()">
                    <i class="bi bi-mouse"></i> Inspeccionar Bot√≥n de Login
                </button>
                <button class="btn btn-success" onclick="testDirectClick()">
                    <i class="bi bi-hand-index"></i> Simular Click Directo
                </button>
            </div>
            <div id="domResults" class="mt-3 border p-3 bg-light" style="height: 200px; overflow-y: auto;"></div>
        </div>

        <!-- Secci√≥n 2: Verificaci√≥n de Event Listeners -->
        <div class="debug-section">
            <h5><i class="bi bi-bug"></i> 2. VERIFICACI√ìN DE EVENT LISTENERS</h5>
            <div id="eventStatus" class="alert alert-secondary">Verificando...</div>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="checkEventListeners()">
                    <i class="bi bi-lightning"></i> Verificar Event Listeners
                </button>
                <button class="btn btn-info" onclick="removeAndReaddListeners()">
                    <i class="bi bi-arrow-clockwise"></i> Remover y Reagregar Listeners
                </button>
            </div>
            <div id="eventResults" class="mt-3 border p-3 bg-light" style="height: 200px; overflow-y: auto;"></div>
        </div>

        <!-- Secci√≥n 3: Pruebas Interactivas -->
        <div class="debug-section">
            <h5><i class="bi bi-play-circle"></i> 3. PRUEBAS INTERACTIVAS</h5>
            <div id="testStatus" class="alert alert-secondary">Esperando pruebas...</div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">Formulario Aislado</div>
                        <div class="card-body">
                            <form id="isolatedTestForm">
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="isolatedEmail" value="admin@restaurante.com">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Contrase√±a</label>
                                    <input type="password" class="form-control" id="isolatedPassword" value="admin123">
                                </div>
                                <button type="submit" class="btn btn-primary w-100" id="isolatedSubmitBtn">
                                    <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesi√≥n (Formulario Aislado)
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">Pruebas de Interacci√≥n</div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="simulateClickByCode()">
                                    <i class="bi bi-code-slash"></i> Simular Click por C√≥digo
                                </button>
                                <button class="btn btn-warning" onclick="testWithDifferentEvent()">
                                    <i class="bi bi-mouse2"></i> Cambiar Tipo de Evento
                                </button>
                                <button class="btn btn-info" onclick="debugWithConsole()">
                                    <i class="bi bi-terminal"></i> Debug con Console
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 4: Logs del Sistema -->
        <div class="debug-section">
            <h5><i class="bi bi-journal-text"></i> 4. LOGS DEL SISTEMA</h5>
            <div class="mt-3">
                <button class="btn btn-outline-secondary" onclick="clearLogs()">
                    <i class="bi bi-trash"></i> Limpiar Logs
                </button>
                <button class="btn btn-outline-info" onclick="exportLogs()">
                    <i class="bi bi-download"></i> Exportar Logs
                </button>
                <button class="btn btn-outline-danger" onclick="testWithManualLogin()">
                    <i class="bi bi-tools"></i> Login Manual Bypass
                </button>
            </div>
            <div id="systemLogs" class="mt-3 border p-3 bg-dark text-light" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 11px;">
                üîç Iniciando diagn√≥stico completo...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let logEntries = [];

        // Utilidades
        function addLog(message, type = 'info', details = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                type,
                message,
                details
            };
            
            logEntries.push(logEntry);
            updateLogsDisplay();
            
            console.log(`[${type.toUpperCase()}] ${message}`, details || '');
        }

        function updateLogsDisplay() {
            const logsDiv = document.getElementById('systemLogs');
            const html = logEntries.slice(-50).reverse().map(entry => {
                const icon = entry.type === 'error' ? '‚ùå' : entry.type === 'success' ? '‚úÖ' : entry.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                const detailsHtml = entry.details ? `<small class="text-muted">${entry.details}</small>` : '';
                return `
                    <div class="log-entry ${entry.type}">
                        [${entry.timestamp}] ${icon} ${entry.message}${detailsHtml}
                    </div>
                `;
            }).join('');
            
            logsDiv.innerHTML = html;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            logEntries = [];
            updateLogsDisplay();
            addLog('üßπ Logs limpiados', 'info');
        }

        function exportLogs() {
            const logsText = logEntries.map(entry => 
                `[${entry.timestamp}] [${entry.type.toUpperCase()}] ${entry.message}${entry.details ? ` - ${entry.details}` : ''}`
            ).join('\n');
            
            const blob = new Blob([logsText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `login-debug-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            
            addLog('üìã Logs exportados', 'info');
        }

        // Secci√≥n 1: Verificaci√≥n del DOM
        function checkDOMElements() {
            document.getElementById('domStatus').className = 'alert alert-info';
            document.getElementById('domStatus').innerHTML = '<strong>üîç Verificando elementos del DOM...</strong>';
            
            const results = document.getElementById('domResults');
            let html = '<h6>Resultados de la verificaci√≥n:</h6>';
            
            // Buscar todos los formularios de login
            const forms = document.querySelectorAll('form');
            html += `<div class="log-entry info">üìã Formularios encontrados: ${forms.length}</div>`;
            
            forms.forEach((form, index) => {
                const formId = form.id || 'sin-id';
                const inputs = form.querySelectorAll('input');
                const buttons = form.querySelectorAll('button[type="submit"]');
                
                html += `<div class="log-entry info">üìù Formulario ${index + 1}: ID="${formId}"</div>`;
                html += `<div class="log-entry info">   - Inputs: ${inputs.length} (email, password)</div>`;
                html += `<div class="log-entry info">   - Submit buttons: ${buttons.length}</div>`;
                
                inputs.forEach((input, i) => {
                    html += `<div class="log-entry">     - Input ${i + 1}: type="${input.type}", id="${input.id}", disabled=${input.disabled}</div>`;
                });
                
                buttons.forEach((button, i) => {
                    html += `<div class="log-entry">     - Button ${i + 1}: type="${button.type}", disabled=${button.disabled}</div>`;
                });
            });
            
            // Buscar espec√≠ficamente el loginForm principal
            const mainLoginForm = document.getElementById('loginForm');
            if (mainLoginForm) {
                html += `<div class="log-entry success">‚úÖ loginForm principal encontrado</div>`;
                
                const emailInput = document.getElementById('loginEmail');
                const passwordInput = document.getElementById('loginPassword');
                const submitButton = mainLoginForm.querySelector('button[type="submit"]');
                
                html += `<div class="log-entry">   - Email input: ${emailInput ? 'encontrado' : 'NO ENCONTRADO'}</div>`;
                html += `<div class="log-entry">   - Password input: ${passwordInput ? 'encontrado' : 'NO ENCONTRADO'}</div>`;
                html += `<div class="log-entry">   - Submit button: ${submitButton ? 'encontrado' : 'NO ENCONTRADO'}</div>`;
                
                if (emailInput && passwordInput && submitButton) {
                    html += `<div class="log-entry success">‚úÖ Elementos del loginForm completos</div>`;
                } else {
                    html += `<div class="log-entry error">‚ùå Faltan elementos del loginForm</div>`;
                }
            } else {
                html += `<div class="log-entry error">‚ùå loginForm principal NO encontrado</div>`;
            }
            
            results.innerHTML = html;
            
            document.getElementById('domStatus').className = logEntries.some(e => e.message.includes('loginForm encontrado')) ? 'alert alert-success' : 'alert alert-warning';
            
            addLog('Verificaci√≥n DOM completada', 'info', `Formularios: ${forms.length}, loginForm principal: ${mainLoginForm ? 'encontrado' : 'NO ENCONTRADO'}`);
        }

        function inspectLoginButton() {
            const submitButton = document.querySelector('#loginForm button[type="submit"]');
            
            if (submitButton) {
                const rect = submitButton.getBoundingClientRect();
                const styles = window.getComputedStyle(submitButton);
                
                addLog('Inspecci√≥n del bot√≥n de login', 'info', `
                    Posici√≥n: (${rect.left}, ${rect.top})
                    Tama√±o: ${rect.width}x${rect.height}
                    Visible: ${rect.width > 0 && rect.height > 0}
                    Display: ${styles.display}
                    Pointer events: ${styles.pointerEvents}
                    Disabled: ${submitButton.disabled}
                    Background: ${styles.backgroundColor}
                    Text: "${submitButton.textContent}"
                `);
                
                // Resaltar el bot√≥n temporalmente
                submitButton.style.border = '3px solid red';
                setTimeout(() => {
                    submitButton.style.border = '';
                }, 2000);
            } else {
                addLog('Bot√≥n de login NO encontrado', 'error');
            }
        }

        function testDirectClick() {
            const submitButton = document.querySelector('#loginForm button[type="submit"]');
            
            if (submitButton) {
                addLog('Simulando click directo en bot√≥n de login', 'info');
                
                // Simular click
                const clickEvent = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    view: window
                });
                
                submitButton.dispatchEvent(clickEvent);
                addLog('Click directo ejecutado', 'info');
                
                // Verificar si el formulario se envi√≥
                setTimeout(() => {
                    const emailValue = document.getElementById('loginEmail')?.value;
                    const passwordValue = document.getElementById('loginPassword')?.value;
                    
                    if (emailValue && passwordValue) {
                        addLog('Formulario tiene valores - enviando login', 'success', `Email: ${emailValue}, Password: ${passwordValue ? '***' : 'vac√≠o'}`);
                        login(emailValue, passwordValue);
                    } else {
                        addLog('Formulario sin valores - no se puede enviar login', 'warning');
                    }
                }, 500);
            } else {
                addLog('Bot√≥n de login NO encontrado para click directo', 'error');
            }
        }

        // Secci√≥n 2: Verificaci√≥n de Event Listeners
        function checkEventListeners() {
            document.getElementById('eventStatus').className = 'alert alert-info';
            document.getElementById('eventStatus').innerHTML = '<strong>üîç Verificando event listeners...</strong>';
            
            const results = document.getElementById('eventResults');
            let html = '<h6>Event Listeners encontrados:</h6>';
            
            try {
                // Verificar si getEventListeners funciona (solo en Chrome DevTools)
                if (window.getEventListeners) {
                    const listeners = window.getEventListeners(document);
                    const submitListeners = listeners.filter(l => l.type === 'submit');
                    
                    html += `<div class="log-entry info">üìä Total listeners: ${listeners.length}</div>`;
                    html += `<div class="log-entry info">üìù Submit listeners: ${submitListeners.length}</div>`;
                    
                    submitListeners.forEach((listener, index) => {
                        html += `<div class="log-entry">   - Listener ${index + 1}: ${listener.listener ? listener.listener.name || 'an√≥nimo' : 'desconocido'}</div>`;
                    });
                } else {
                    html += `<div class="log-entry warning">‚ö†Ô∏è getEventListeners no disponible en este navegador</div>`;
                }
            } catch (error) {
                html += `<div class="log-entry error">‚ùå Error al verificar listeners: ${error.message}</div>`;
            }
            
            results.innerHTML = html;
            document.getElementById('eventStatus').className = 'alert alert-success';
            
            addLog('Verificaci√≥n de event listeners completada', 'info');
        }

        function removeAndReaddListeners() {
            addLog('Removiendo y reagregando event listeners', 'info');
            
            const forms = document.querySelectorAll('form');
            
            forms.forEach((form, index) => {
                const clone = form.cloneNode(true);
                const parent = form.parentNode;
                
                parent.replaceChild(clone, form);
                
                if (form.id === 'loginForm') {
                    const newForm = document.getElementById('loginForm');
                    
                    newForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        addLog('üöÄ Event listener NUEVO ejecutado', 'success', `Formulario: ${form.id}`);
                        
                        const email = document.getElementById('loginEmail')?.value || '';
                        const password = document.getElementById('loginPassword')?.value || '';
                        
                        if (email && password) {
                            addLog('üîë Ejecutando login con credenciales', 'info', `Email: ${email}`);
                            login(email, password);
                        } else {
                            addLog('‚ùå Formulario sin valores', 'warning');
                        }
                    });
                    
                    addLog('‚úÖ Event listener reagregado exitosamente', 'success');
                }
            });
            
            addLog('Event listeners actualizados', 'info');
        }

        // Secci√≥n 3: Pruebas Interactivas
        function simulateClickByCode() {
            const submitButton = document.querySelector('#loginForm button[type="submit"]');
            
            if (submitButton) {
                addLog('Simulando click por c√≥digo JavaScript', 'info');
                
                // Usar m√∫ltiples m√©todos para simular click
                const methods = [
                    () => submitButton.click(),
                    () => {
                        const event = new MouseEvent('click', { bubbles: true, cancelable: true, view: window });
                        submitButton.dispatchEvent(event);
                    },
                    () => {
                        const event = new Event('click', { bubbles: true });
                        submitButton.dispatchEvent(event);
                    },
                    () => {
                        submitButton.onclick();
                    }
                ];
                
                methods.forEach((method, index) => {
                    setTimeout(() => {
                        try {
                            addLog(`M√©todo ${index + 1}: ${method.name}`, 'info');
                            method();
                            addLog(`M√©todo ${index + 1}: ejecutado`, 'success');
                        } catch (error) {
                            addLog(`M√©todo ${index + 1}: error - ${error.message}`, 'error');
                        }
                    }, 1000 * (index + 1));
                });
            } else {
                addLog('Bot√≥n de login NO encontrado para simulaci√≥n', 'error');
            }
        }

        function testWithDifferentEvent() {
            const form = document.getElementById('loginForm');
            const submitButton = form?.querySelector('button[type="submit"]');
            
            if (form && submitButton) {
                addLog('Probando con evento personalizado', 'info');
                
                // Remover listener existente
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);
                
                // Agregar nuevo listener con debugging
                const newFormElement = document.getElementById('loginForm');
                
                newFormElement.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addLog('üöÄ EVENTO PERSONALIZADO DETECTADO', 'success', `
                        Event type: ${e.type}
                        Event target: ${e.target.tagName}
                        Submit button: ${e.submitter ? e.submitter.tagName : 'desconocido'}
                        Form ID: ${e.target.id}
                        Timestamp: ${new Date().toISOString()}
                    `);
                    
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    if (email && password) {
                        addLog('Ejecutando login desde evento personalizado', 'info');
                        login(email, password);
                    } else {
                        addLog('Formulario vac√≠o - no se puede ejecutar login', 'warning');
                    }
                });
                
                addLog('Evento personalizado configurado', 'success');
            } else {
                addLog('Formulario o bot√≥n no encontrado', 'error');
            }
        }

        function debugWithConsole() {
            addLog('Iniciando debug con console integrado', 'info');
            
            const form = document.getElementById('loginForm');
            const email = document.getElementById('loginEmail');
            const password = document.getElementById('loginPassword');
            const submitButton = form?.querySelector('button[type="submit"]');
            
            // Verificar estado completo
            const state = {
                formExists: !!form,
                emailExists: !!email,
                passwordExists: !!password,
                buttonExists: !!submitButton,
                formAction: form?.action,
                formMethod: form?.method,
                emailValue: email?.value,
                passwordValue: password?.value,
                buttonDisabled: submitButton?.disabled,
                buttonVisible: submitButton ? (submitButton.offsetWidth > 0 && submitButton.offsetHeight > 0) : false,
                listeners: 'Verificando...'
            };
            
            addLog('Estado completo del formulario de login:', 'info', JSON.stringify(state, null, 2));
            
            if (state.formExists && state.emailExists && state.passwordExists && state.buttonExists) {
                addLog('Todos los elementos del formulario existen', 'success');
                
                // Intentar login directamente
                if (state.emailValue && state.passwordValue) {
                    addLog('Ejecutando login directo (bypass form)', 'info');
                    login(state.emailValue, state.passwordValue);
                } else {
                    addLog('Formulario vac√≠o - llenar campos primero', 'warning');
                }
            } else {
                addLog('Faltan elementos del formulario', 'error', JSON.stringify(state, null, 2));
            }
        }

        function testWithManualLogin() {
            addLog('Ejecutando login manual (completamente bypass)', 'info');
            
            // Login directo sin depender del formulario
            login('admin@restaurante.com', 'admin123');
        }

        // Funci√≥n login
        async function login(email, password) {
            try {
                addLog('Iniciando petici√≥n de login', 'info', `Email: ${email}`);
                
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                addLog('Respuesta recibida', 'info', `Status: ${response.status}`);
                
                const data = await response.json();
                
                if (response.ok) {
                    addLog('Login exitoso', 'success', `Usuario: ${data.user.nombre} (${data.user.rol})`);
                    
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        addLog('Token guardado en localStorage', 'success');
                        
                        // Mostrar success message
                        if (typeof showToast !== 'undefined') {
                            showToast(`Bienvenido ${data.user.nombre}`, 'success');
                        }
                    }
                    
                    // Redirigir seg√∫n rol
                    if (data.user.rol === 'administrador') {
                        addLog('Redirigiendo a dashboard', 'info');
                        if (typeof showSection !== 'undefined') {
                            showSection('admin');
                        }
                    }
                } else {
                    const error = data.error || 'Error desconocido';
                    addLog('Error en login', 'error', error);
                    
                    if (typeof showToast !== 'undefined') {
                        showToast(error, 'danger');
                    }
                }
            } catch (error) {
                addLog('Error de conexi√≥n', 'error', error.message);
                
                if (typeof showToast !== 'undefined') {
                    showToast('Error de conexi√≥n al servidor', 'danger');
                }
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            addLog('P√°gina de diagn√≥stico inicializada', 'success');
            
            // Configurar listeners para el formulario aislado
            const isolatedForm = document.getElementById('isolatedTestForm');
            if (isolatedForm) {
                isolatedForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addLog('Formulario aislado enviado', 'info');
                    
                    const email = document.getElementById('isolatedEmail').value;
                    const password = document.getElementById('isolatedPassword').value;
                    
                    if (email && password) {
                        addLog('Login desde formulario aislado', 'info', `Email: ${email}`);
                        login(email, password);
                    } else {
                        addLog('Formulario aislado vac√≠o', 'warning');
                    }
                });
            }
            
            // Verificaci√≥n inicial autom√°tica
            setTimeout(checkDOMElements, 1000);
        });
    </script>
</body>
</html>