<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Login Admin - Versi√≥n 2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1>üîß Diagn√≥stico Login Admin v2</h1>
        <div class="alert alert-info">
            <strong>Prop√≥sito:</strong> Diagnosticar el error de conexi√≥n persistente cuando el administrador inicia sesi√≥n
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">Test de Login</div>
                    <div class="card-body">
                        <div id="step1Status" class="alert alert-secondary mb-3">
                            Paso 1: Esperando inicio de prueba...
                        </div>
                        
                        <div id="step2Status" class="alert alert-secondary mb-3">
                            Paso 2: Esperando verificaci√≥n de token...
                        </div>
                        
                        <div id="step3Status" class="alert alert-secondary mb-3">
                            Paso 3: Esperando prueba de dashboard...
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg" onclick="runFullTest()">
                                <i class="bi bi-play-circle"></i> Ejecutar Diagn√≥stico Completo
                            </button>
                            <button class="btn btn-info" onclick="checkDOMState()">
                                <i class="bi bi-search"></i> Verificar Estado DOM
                            </button>
                            <button class="btn btn-warning" onclick="clearLocalStorage()">
                                <i class="bi bi-trash"></i> Limpiar Storage
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-dark text-white">Logs Detallados</div>
                    <div class="card-body">
                        <div id="diagnosticLogs" class="border p-3 bg-dark text-light" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 11px;">
                            Iniciando diagn√≥stico...
                        </div>
                        
                        <div class="mt-3">
                            <h6>Estado Actual:</h6>
                            <div id="currentState" class="border p-2 bg-light" style="font-family: monospace; font-size: 12px;">
                                Esperando diagn√≥stico...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';
        
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('diagnosticLogs');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            logsDiv.innerHTML += `<div>[${timestamp}] ${icon} ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function updateStep(step, message, type = 'info') {
            const stepEl = document.getElementById(`step${step}Status`);
            stepEl.className = `alert alert-${type}`;
            stepEl.innerHTML = `<strong>Paso ${step}:</strong> ${message}`;
        }

        function updateCurrentState(state) {
            const stateDiv = document.getElementById('currentState');
            stateDiv.innerHTML = `
                <strong>Estado:</strong> ${state}<br>
                <strong>Tiempo:</strong> ${new Date().toLocaleString()}<br>
                <strong>URL:</strong> ${window.location.href}<br>
                <strong>User Agent:</strong> ${navigator.userAgent}
            `;
        }

        async function runFullTest() {
            addLog('üöÄ Iniciando diagn√≥stico completo...');
            
            // Paso 1: Login
            updateStep(1, 'Iniciando login de administrador...', 'info');
            addLog('Paso 1: Enviando solicitud de login...');
            
            try {
                const loginResponse = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@restaurante.com',
                        password: 'admin123'
                    })
                });
                
                addLog(`Status login: ${loginResponse.status}`);
                
                if (!loginResponse.ok) {
                    throw new Error('Fall√≥ login');
                }
                
                const loginData = await loginResponse.json();
                addLog(`Login exitoso: ${JSON.stringify(loginData.user)}`);
                
                updateStep(1, 'Login exitoso', 'success');
                
                // Paso 2: Verificar token
                updateStep(2, 'Verificando token...', 'info');
                addLog('Paso 2: Token recibido y guardado en localStorage');
                
                const token = loginData.token;
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(loginData.user));
                
                updateStep(2, 'Token guardado correctamente', 'success');
                
                // Paso 3: Probar dashboard con nuevo token
                updateStep(3, 'Probando dashboard...', 'info');
                addLog('Paso 3: Enviando solicitud a dashboard con nuevo token...');
                
                const dashboardResponse = await fetch(`${API_BASE}/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                addLog(`Status dashboard: ${dashboardResponse.status}`);
                
                if (!dashboardResponse.ok) {
                    const errorData = await dashboardResponse.json();
                    throw new Error(`Error dashboard: ${errorData.error || 'Error desconocido'}`);
                }
                
                const dashboardData = await dashboardResponse.json();
                addLog(`Dashboard exitoso: ${JSON.stringify(dashboardData)}`);
                
                updateStep(3, 'Dashboard funcionando correctamente', 'success');
                
                // Verificar elementos DOM
                setTimeout(() => checkDOMState(), 1000);
                
            } catch (error) {
                addLog(`‚ùå Error en diagn√≥stico: ${error.message}`, 'error');
                updateCurrentState(`ERROR: ${error.message}`);
            }
        }

        function checkDOMState() {
            addLog('üîç Verificando estado del DOM...');
            
            const elements = {
                'totalReservas': document.getElementById('totalReservas'),
                'reservasHoy': document.getElementById('reservasHoy'),
                'mesasDisponibles': document.getElementById('mesasDisponibles'),
                'totalComensales': document.getElementById('totalComensales'),
                'allReservationsTable': document.getElementById('allReservationsTable')
            };
            
            let foundCount = 0;
            let missingElements = [];
            
            for (const [name, element] of Object.entries(elements)) {
                if (element) {
                    addLog(`‚úÖ Elemento '${name}' encontrado`, 'success');
                    foundCount++;
                } else {
                    addLog(`‚ùå Elemento '${name}' NO encontrado`, 'error');
                    missingElements.push(name);
                }
            }
            
            updateCurrentState(`
                Elementos encontrados: ${foundCount}/${Object.keys(elements).length}
                Elementos faltantes: ${missingElements.join(', ')}
            `);
        }

        function clearLocalStorage() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            addLog('üßπ LocalStorage limpiado');
            updateCurrentState('LocalStorage limpiado');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üåü P√°gina de diagn√≥stico v2 lista');
            updateCurrentState('Esperando usuario...');
        });
    </script>
</body>
</html>