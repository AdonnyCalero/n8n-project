<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Dashboard - Soluci√≥n Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1>üîß Prueba de Dashboard - Soluci√≥n del Problema</h1>
        
        <div class="alert alert-info mb-4">
            <h5>üéØ Objetivo:</h5>
            <p>Identificar y solucionar el problema donde el dashboard muestra error pero no carga los datos.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">Paso 1: Autenticaci√≥n</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Email Admin:</label>
                            <input type="email" class="form-control" id="adminEmail" value="admin@restaurante.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contrase√±a:</label>
                            <input type="password" class="form-control" id="adminPassword" value="admin123">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="testLogin()">
                                <i class="bi bi-box-arrow-in-right"></i> 1. Login Admin
                            </button>
                            <button class="btn btn-info" onclick="checkAuth()">
                                <i class="bi bi-shield-check"></i> Verificar Auth
                            </button>
                        </div>
                        
                        <div id="authStatus" class="mt-3 alert alert-secondary">
                            Esperando autenticaci√≥n...
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">Paso 2: Dashboard</div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="testDashboard()">
                                <i class="bi bi-speedometer2"></i> 2. Cargar Dashboard
                            </button>
                            <button class="btn btn-warning" onclick="testDashboardWithRetry()">
                                <i class="bi bi-arrow-clockwise"></i> 2a. Cargar con Reintentos
                            </button>
                            <button class="btn btn-danger" onclick="testManualDashboard()">
                                <i class="bi bi-tools"></i> 2b. Cargar Manual
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Estado Dashboard:</h6>
                            <div id="dashboardStatus" class="alert alert-secondary">
                                Esperando prueba...
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Elementos del Dashboard:</h6>
                            <div id="dashboardElements" class="border p-2 bg-light">
                                <div>Total Reservas: <span id="totalReservasStatus">‚è≥</span></div>
                                <div>Reservas Hoy: <span id="reservasHoyStatus">‚è≥</span></div>
                                <div>Mesas Disponibles: <span id="mesasDisponiblesStatus">‚è≥</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">üìä Logs Detallados</div>
                    <div class="card-body">
                        <div id="testLogs" class="border p-3 bg-dark text-light" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 11px;">
                            üöÄ Iniciando sistema de pruebas...
                        </div>
                        
                        <div class="mt-3 d-grid gap-2">
                            <button class="btn btn-outline-secondary" onclick="clearLogs()">
                                <i class="bi bi-trash"></i> Limpiar Logs
                            </button>
                            <button class="btn btn-outline-info" onclick="exportLogs()">
                                <i class="bi bi-download"></i> Exportar Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = null;

        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('testLogs');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            logsDiv.innerHTML += `<div>[${timestamp}] ${icon} ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function updateAuthStatus(message, type = 'info') {
            const statusDiv = document.getElementById('authStatus');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.innerHTML = `<strong>Estado:</strong> ${message}`;
        }

        function updateDashboardStatus(message, type = 'info') {
            const statusDiv = document.getElementById('dashboardStatus');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.innerHTML = `<strong>Estado:</strong> ${message}`;
        }

        function updateElementsStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.textContent = status;
        }

        function updateAllElements() {
            const totalReservas = document.getElementById('totalReservas');
            const reservasHoy = document.getElementById('reservasHoy');
            const mesasDisponibles = document.getElementById('mesasDisponibles');
            
            updateElementsStatus('totalReservasStatus', totalReservas ? '‚úÖ' : '‚ùå');
            updateElementsStatus('reservasHoyStatus', reservasHoy ? '‚úÖ' : '‚ùå');
            updateElementsStatus('mesasDisponiblesStatus', mesasDisponibles ? '‚úÖ' : '‚ùå');
        }

        async function testLogin() {
            addLog('üöÄ Iniciando login de administrador...');
            updateAuthStatus('Iniciando sesi√≥n...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('adminEmail').value,
                        password: document.getElementById('adminPassword').value
                    })
                });
                
                addLog(`üìä Status login: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    
                    addLog(`‚úÖ Login exitoso: ${data.user.nombre} (${data.user.rol})`);
                    addLog(`üîë Token obtenido: ${data.token.substring(0, 20)}...`);
                    
                    updateAuthStatus(`‚úÖ Autenticado como ${data.user.nombre}`, 'success');
                } else {
                    const errorData = await response.json();
                    addLog(`‚ùå Error login: ${errorData.error || 'Error desconocido'}`);
                    updateAuthStatus(`‚ùå Error: ${errorData.error || 'Login fallido'}`, 'danger');
                }
            } catch (error) {
                addLog(`üí• Error en login: ${error.message}`);
                updateAuthStatus(`üí• Error de conexi√≥n: ${error.message}`, 'danger');
            }
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                authToken = token;
                const userData = JSON.parse(user);
                addLog(`‚úÖ Auth encontrada: ${userData.nombre} (${userData.rol})`);
                updateAuthStatus(`‚úÖ Autenticado como ${userData.nombre}`, 'success');
            } else {
                addLog('‚ö†Ô∏è No hay autenticaci√≥n guardada');
                updateAuthStatus('‚ö†Ô∏è No autenticado', 'warning');
            }
        }

        async function testDashboard() {
            addLog('üöÄ Iniciando prueba de dashboard simple...');
            updateDashboardStatus('Iniciando carga...', 'info');
            
            if (!authToken) {
                addLog('‚ùå No hay token. Iniciando sesi√≥n primero...');
                updateDashboardStatus('‚ùå No autenticado', 'danger');
                await testLogin();
                return;
            }
            
            try {
                addLog('üì° Solicitando dashboard...');
                const response = await fetch(`${API_BASE}/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                addLog(`üìä Status dashboard: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addLog(`üìä Datos dashboard: ${JSON.stringify(data)}`);
                    
                    updateDashboardStatus('‚úÖ Dashboard cargado correctamente', 'success');
                    
                    // Verificar elementos del DOM
                    setTimeout(() => {
                        updateAllElements();
                        addLog('‚úÖ Verificaci√≥n de elementos DOM completada');
                    }, 500);
                    
                } else {
                    const errorData = await response.json();
                    addLog(`‚ùå Error dashboard: ${errorData.error || 'Error desconocido'}`);
                    updateDashboardStatus(`‚ùå Error: ${errorData.error || 'Error al cargar dashboard'}`, 'danger');
                }
            } catch (error) {
                addLog(`üí• Error en dashboard: ${error.message}`);
                updateDashboardStatus(`üí• Error de conexi√≥n: ${error.message}`, 'danger');
            }
        }

        async function testDashboardWithRetry() {
            addLog('üîÑ Iniciando prueba de dashboard con reintentos...');
            
            let retries = 0;
            const maxRetries = 3;
            
            for (let i = 0; i < maxRetries; i++) {
                updateDashboardStatus(`Intento ${i + 1}/${maxRetries}...`, 'warning');
                
                try {
                    if (!authToken) {
                        addLog('‚ùå No hay token. Reintentando login...');
                        await testLogin();
                        i = maxRetries; // Salir del loop
                        break;
                    }
                    
                    const response = await fetch(`${API_BASE}/dashboard`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addLog(`‚úÖ Intento ${i + 1} exitoso`);
                        addLog(`üìä Datos: ${JSON.stringify(data)}`);
                        
                        updateDashboardStatus('‚úÖ Dashboard cargado con reintentos', 'success');
                        
                        setTimeout(() => updateAllElements(), 500);
                        return;
                    } else {
                        const errorData = await response.json();
                        addLog(`‚ùå Intento ${i + 1} fallido: ${errorData.error}`);
                    }
                } catch (error) {
                    addLog(`üí• Intento ${i + 1} error: ${error.message}`);
                }
                
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            updateDashboardStatus('‚ùå Todos los intentos fallaron', 'danger');
        }

        async function testManualDashboard() {
            addLog('üõ†Ô∏è Iniciando prueba manual de dashboard...');
            updateDashboardStatus('Iniciando prueba manual...', 'info');
            
            // Simular elementos del dashboard
            const totalReservas = document.getElementById('totalReservas');
            const reservasHoy = document.getElementById('reservasHoy');
            const mesasDisponibles = document.getElementById('mesasDisponibles');
            
            if (totalReservas && reservasHoy && mesasDisponibles) {
                addLog('‚úÖ Elementos del dashboard encontrados en el DOM');
                
                // Simular carga de datos
                totalReservas.textContent = '25';
                reservasHoy.textContent = '12';
                mesasDisponibles.textContent = '8';
                
                updateDashboardStatus('‚úÖ Prueba manual exitosa', 'success');
                updateAllElements();
                
                addLog('üìä Datos simulados cargados en elementos');
            } else {
                addLog('‚ùå Elementos del dashboard NO encontrados en el DOM');
                updateDashboardStatus('‚ùå Error: Elementos del dashboard no encontrados', 'danger');
            }
        }

        function clearLogs() {
            document.getElementById('testLogs').innerHTML = 'üöÄ Logs limpiados';
        }

        function exportLogs() {
            const logs = document.getElementById('testLogs').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-test-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            addLog('üìã Logs exportados');
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üåü P√°gina de pruebas de dashboard inicializada');
            checkAuth();
        });
    </script>
</body>
</html>